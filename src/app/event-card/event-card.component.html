<div class="full-page">
  <div *ngIf="!isDialog() && !fromMap">
    <button
      mat-raised-button
      color="primary"
      (click)="addTask()"
      *ngIf="isDispatcher()"
    >
      הוספת נסיעה
    </button>
    <app-dots-menu [buttons]="buttons" *ngIf="isDispatcher()"></app-dots-menu>
    <data-area [settings]="area"></data-area>
    <div
      *ngIf="tasks.length"
      style="
        display: flex;
        justify-content: space-between;
        flex-direction: row-reverse;
      "
    >
      <button
        mat-raised-button
        color="primary"
        (click)="sortByDistance()"
        *ngIf="!showSortOptions"
      >
        <mat-icon>location_on</mat-icon>קרוב אלי
      </button>
      <mat-form-field
        *ngIf="showSortOptions"
        appearance="outline"
        class="dense-form-field"
        style="margin-bottom: -8px"
      >
        <mat-label>הצג לפי</mat-label>
        <div>
          <select
            matNativeControl
            [(ngModel)]="currentSort"
            (change)="currentSort.selected()"
          >
            <option *ngFor="let v of sortOptions" [ngValue]="v">
              {{ v.caption }}
            </option>
          </select>
        </div>
      </mat-form-field>
      <div style="align-self: center">
        <button
          *ngIf="!showMap"
          mat-raised-button
          (click)="toggleShowMap(true)"
          color="primary"
        >
          <mat-icon>map</mat-icon> מפה
        </button>
        <button
          *ngIf="showMap"
          mat-raised-button
          color="primary"
          (click)="toggleShowMap(false)"
        >
          חזרה לרשימה
        </button>
      </div>
    </div>
    <mat-divider></mat-divider>
  </div>
  <div *ngIf="isDialog()">
    {{ title }}
  </div>
  <div *ngIf="showMap" class="grow-item" style="position: relative">
    <app-noam-test [tasks]="tasksForMap"></app-noam-test>
  </div>
  <div *ngIf="!showMap" [class.grow-item]="!fromMap">
    <div *ngFor="let d of urgencies">
      <ng-container *ngIf="hasEvents(d)">
        <strong *ngIf="urgencies.length > 1">{{ d.urgency }}:</strong>
        <div class="events-container" [transition-group]="'flip-list'">
          <ng-container *ngFor="let e of d.events; trackBy: trackBy">
            <mat-card
              transition-group-item
              class="event-card"
              [class.registered]="isRegisteredToEvent(e) && showingAllTasks"
              *ngIf="filter(e)"
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin-bottom: 5px;
                "
              >
                <strong (click)="eventDetails(e)">
                  {{ e.title }}
                </strong>
                <a (click)="eventDetails(e)" *ngIf="!isFull(e) && fromMap">{{
                  'לפרטים'
                }}</a>
                <app-dots-menu
                  [item]="e"
                  [buttons]="menuOptions"
                  *ngIf="isDispatcher() && !fromMap"
                ></app-dots-menu>
              </div>
              <div class="event-info" (click)="eventDetails(e)">
                <div class="event-detail">
                  <span style="margin-bottom: 10px">
                    <span
                      *ngIf="onTheWayBack(e)"
                      style="font-weight: bold; color: red"
                      >בדרך חזרה,
                    </span>
                    {{ e.category || ''
                    }}<span style="font-size: 12px"> {{ distance(e) }}</span>
                  </span>

                  <div class="route-start-finish">
                    <div class="route-indicator-container">
                      <div
                        class="row"
                        style="padding-left: 10px; padding-right: 10px"
                      >
                        <div class="dot right"></div>
                        <div class="line"></div>
                        <div class="arrow-container">
                          <div class="arrow"></div>
                          <div
                            class="distance-text"
                            *ngIf="e.toAddressApiResult"
                          >
                            {{ travelDistance(e) }}
                          </div>
                        </div>
                        <div class="dot left"></div>
                      </div>
                      <div class="row" style="padding-top: 5px">
                        <div class="text">{{ eventCity(e) }}</div>
                        <div class="text">
                          <span *ngIf="e.toAddressApiResult">
                            {{ eventToCity(e) }}</span
                          >
                        </div>
                      </div>
                    </div>
                  </div>
                  <div style="margin-bottom: 10px">
                    {{ displayDate(e) }}
                  </div>
                  <!-- <span>
                    {{ eventCity(e) }}
                    <span *ngIf="e.toAddressApiResult">
                      => {{ eventToCity(e) }} ({{ travelDistance(e) }})</span
                    >
                  </span> -->

                  <div class="bottom-container">
                    <a *ngIf="!isFull(e) && !fromMap">{{ 'לפרטים' }}</a>
                    <strong *ngIf="isFull(e)">
                      {{ e.taskStatus.caption }}
                      <span *ngIf="e.driver">, {{ e.driver.name }}</span>
                    </strong>
                    <div class="id-text">{{ e.externalId }}#</div>
                  </div>
                </div>
              </div>
            </mat-card>
          </ng-container>
        </div>
      </ng-container>
    </div>
  </div>
</div>
